---
- name: Bootstrap basic
  hosts: all
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - local.common-packages
    - brianshumate.consul
  handlers:
    - name: restart networking
      service:
        name: networking
        state: restarted
        sleep: 5
  tasks:
    - name: Disable ipv6
      sysctl:
        name: net.ipv6.conf.all.disable_ipv6
        # Value is a string field
        value: '1'
        sysctl_set: true
        state: present
        reload: true
    - name: Deploy dhclient.conf
      copy:
        dest: /etc/dhcp/dhclient.conf
        src: files/dhclient.conf
        backup: true
        mode: 0644
        owner: root
        group: root
      notify: restart networking

- name: Configure PostgreSQL
  hosts: meta-role_postgresql_server
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - local.pgdg
    - geerlingguy.postgresql
    - local.timescaledb

- name: Bootstrap client basic configuration
  hosts: meta-role_client
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - local.pgdg
    - andrewrothstein.go
  tasks:
    - name:
      apt:
        name: "{{ item }}"
      with_items: "{{ postgresql_client_packages }}"
    - name: Configure GOPATH
      copy:
        dest: /etc/profile.d/gopath.sh
        content: |
          export GOPATH=$HOME/go/
          export PATH="${GOPATH}/bin:${PATH}"
        owner: root
        group: root
        mode: '0644'

- name: Boostrap timescale_prometheus connector
  hosts: meta-subrole_timescale_prometheus
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - local.timescale-prometheus

- name: Boostrap prometheus
  hosts: meta-subrole_prometheus
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - cloudalchemy.prometheus

- name: Install and configure grafana
  hosts: meta-subrole_grafana
  any_errors_fatal: true
  become: true
  become_user: root
  roles:
    - role: cloudalchemy.grafana
