---

# defaults file for consul-template
consul_template_version: "0.25.1"
consul_template_use_systemd: true
consul_template_templates:
  - name: "haproxy.ctmpl"
    dest: "/etc/haproxy/haproxy.cfg"
    cmd: "systemctl reload haproxy.service"
    perms: "0600"
    backup: "true"
    wait: "2s"

haproxy_exporter_version: 0.12.0
haproxy_exporter_tarball_checksum: sha1:128e0b69113325c4f857595819bc836f4697fbc8
haproxy_exporter_options:
  - --haproxy.scrape-uri=unix:/run/haproxy.sock
  - --web.listen-address=localhost:9101

nginx_config_http_template:
  app:
    servers:
      main:
        reverse_proxy:
          locations:
            haproxy_exporter:
              location: /haproxy_exporter/
              proxy_cache: exporter
              proxy_pass: "http://localhost:9101/"
              proxy_cache_background_update: false
              proxy_cache_lock: true
              proxy_cache_min_uses: 1
              proxy_set_header:
                header_host:
                  name: Host
                  value: $host

consul_services:
  - name: "node-exporter"
    id: "node-exporter"
    address: "{{ private_ip }}"
    port: 8888
    checks:
      - tcp: "localhost:9100"
        interval: "10s"
  - name: "haproxy-exporter"
    id: "haproxy-exporter"
    address: "{{ private_ip }}"
    port: 8888
    checks:
      - http: http://localhost:9101/health
        interval: "10s"
